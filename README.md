# ShiwaPTPTool - Precision Time Protocol Management Tool

**Copyright (c) 2024 SHIWA NETWORK - All rights reserved**

ShiwaPTPTool - это комплексное решение для управления PTP (Precision Time Protocol) часами с поддержкой как командной строки (CLI), так и графического интерфейса (GUI).

## Возможности

### Основные функции:
- **Управление временем**: получение, установка и синхронизация времени PTP часов
- **Измерение смещения**: точное измерение смещения между системным временем и PTP часами
- **Управление пинами**: конфигурация и мониторинг пинов PTP устройства
- **Сетевое взаимодействие**: отправка и получение временных меток по сети
- **Настройка частоты**: регулировка частоты PTP часов
- **PPS управление**: включение/выключение импульсов в секунду

### Интерфейсы:
- **CLI версия**: полная функциональность через командную строку
- **GUI версия**: удобный графический интерфейс с вкладками

## Требования к системе

### Системные требования:
- Linux с ядром 3.0 или выше
- Поддержка PTP в ядре
- Права root для работы с PTP устройствами

### Зависимости для сборки:

#### Для CLI версии:
```bash
sudo apt-get update
sudo apt-get install build-essential libevent-dev
```

#### Для GUI версии (дополнительно):
```bash
sudo apt-get install qt5-default libqt5core5a libqt5widgets5a libqt5gui5a
```

## Установка

### 1. Клонирование репозитория
```bash
git clone <repository-url>
cd PTPtool
```

### 2. Сборка
```bash
# Сборка обеих версий
make all

# Или только CLI версии
make shiwaptptool-cli

# Или только GUI версии
make shiwaptptool-gui
```

### 3. Установка (опционально)
```bash
# Установка в систему
sudo make install

# Удаление из системы
sudo make uninstall
```

## Использование

### CLI версия

#### Основной синтаксис:
```bash
shiwaptptool-cli [опции]
```

#### Основные опции:

**Управление устройством:**
- `-d <индекс>` - указать PTP устройство (например, -d 0 для /dev/ptp0)

**Управление временем:**
- `-g` - получить текущее время PTP часов
- `-s` - установить время PTP часов из системного времени
- `-S` - установить системное время из PTP часов
- `-t <секунды>` - сдвинуть время PTP часов на указанное количество секунд
- `-T <секунды>` - установить время PTP часов в указанное значение
- `-f <ppb>` - настроить частоту PTP часов (в частях на миллиард)

**Информация о часах:**
- `-c` - показать возможности PTP устройства
- `-k <количество>` - измерить смещение между системным и PTP временем (максимум 25 измерений)

**Управление пинами:**
- `-l` - показать текущую конфигурацию пинов
- `-L <пин,функция>` - настроить пин с указанной функцией

**Сетевые функции:**
- `-E <адрес>` - отправить временные метки на указанный адрес
- `-G` - запустить сервер для приема временных меток
- `-n <имя>` - указать имя хоста для сетевых операций

#### Примеры использования:

**Получение времени:**
```bash
sudo shiwaptptool-cli -d 0 -g
```

**Показать возможности устройства:**
```bash
sudo shiwaptptool-cli -d 0 -c
```

**Измерить смещение (5 измерений):**
```bash
sudo shiwaptptool-cli -d 0 -k 5
```

**Настроить частоту:**
```bash
sudo shiwaptptool-cli -d 0 -f 1000
```

**Запустить сервер:**
```bash
shiwaptptool-cli -G
```

**Отправить события на удаленный сервер:**
```bash
sudo shiwaptptool-cli -d 0 -e 10 -E 192.168.1.100 -n myhost
```

### GUI версия

#### Запуск:
```bash
shiwaptptool-gui
```

#### Интерфейс:

**Вкладка "Device":**
- Выбор PTP устройства
- Подключение/отключение от устройства
- Просмотр возможностей устройства

**Вкладка "Time Management":**
- Получение текущего времени
- Настройка времени и частоты
- Синхронизация с системным временем

**Вкладка "Offset Measurement":**
- Измерение смещения между системным и PTP временем
- Настройка количества измерений
- Отображение результатов

**Вкладка "Pin Management":**
- Просмотр конфигурации пинов
- Управление функциями пинов

**Вкладка "Network":**
- Настройка сетевых параметров
- Запуск/остановка сервера
- Мониторинг сетевого трафика

## Конфигурация

### Проверка доступности PTP устройств:
```bash
ls /dev/ptp*
```

### Проверка поддержки PTP в ядре:
```bash
modprobe ptp
```

### Настройка сетевых интерфейсов для PTP:
```bash
# Пример для eth0
sudo ethtool -T eth0
```

## Устранение неполадок

### Ошибка "user is not root":
```bash
sudo ptptool-cli [опции]
```

### Ошибка "no device is specified":
```bash
# Укажите устройство с помощью -d
sudo ptptool-cli -d 0 [другие опции]
```

### Ошибка "opening /dev/ptpX":
- Убедитесь, что PTP устройство существует
- Проверьте права доступа
- Убедитесь, что драйвер PTP загружен

### Проблемы с GUI:
- Убедитесь, что установлены Qt5 библиотеки
- Проверьте переменную окружения DISPLAY
- Запустите с правами root для полной функциональности

## Разработка

### Структура проекта:
```
PTPtool/
├── src/
│   ├── ptptool_cli.cpp    # CLI версия
│   └── ptptool_gui.cpp    # GUI версия
├── Makefile               # Сборка
├── README.md             # Документация
└── ptptool.cpp          # Оригинальная версия
```

### Сборка для разработки:
```bash
# Форматирование кода
make format

# Очистка
make clean

# Справка
make help
```

## Лицензия

Этот проект распространяется под лицензией [указать лицензию].

## Поддержка

Для получения поддержки или сообщения об ошибках, пожалуйста, создайте issue в репозитории проекта.

## История версий

### Версия 2.0
- Добавлена поддержка GUI интерфейса
- Улучшена структура CLI кода
- Добавлена подробная документация
- Улучшена обработка ошибок

### Версия 1.0
- Базовая CLI функциональность
- Поддержка основных PTP операций